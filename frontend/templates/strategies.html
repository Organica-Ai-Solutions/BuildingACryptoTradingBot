<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategies - Crypto Trading Bot</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-currency-bitcoin me-2"></i>Crypto Trading Bot
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/strategies">Strategies</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history">Trade History</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div id="statusIndicator" class="status offline me-2"></div>
                    <span id="tradingStatus" class="me-2">Offline</span>
                    <button id="startTradingBtn" class="btn btn-success btn-sm me-2">
                        <i class="bi bi-play-fill"></i> Start Trading
                    </button>
                    <button id="stopTradingBtn" class="btn btn-danger btn-sm me-2" style="display: none;">
                        <i class="bi bi-stop-fill"></i> Stop Trading
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container pt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Trading Strategies</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStrategyModal">
                    <i class="bi bi-plus-circle me-2"></i>Add Strategy
                </button>
            </div>
            
            <!-- Strategy Cards -->
            <div class="row" id="strategiesContainer">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading strategies...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Strategy Modal -->
    <div class="modal fade" id="addStrategyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Trading Strategy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="strategyForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="symbolSelect" class="form-label">Trading Symbol</label>
                                <select class="form-select" id="symbolSelect" required>
                                    <option value="">Select Symbol</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="strategySelect" class="form-label">Strategy Type</label>
                                <select class="form-select" id="strategySelect" required>
                                    <option value="">Select Strategy</option>
                                    <option value="supertrend">Supertrend</option>
                                    <option value="macd">MACD Momentum</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="capitalInput" class="form-label">Capital Allocation ($)</label>
                                <input type="number" class="form-control" id="capitalInput" min="100" step="100" value="1000" required>
                            </div>
                            <div class="col-md-6">
                                <label for="riskInput" class="form-label">Risk Per Trade (%)</label>
                                <input type="number" class="form-control" id="riskInput" min="0.1" max="10" step="0.1" value="1" required>
                            </div>
                        </div>
                        
                        <!-- Supertrend Parameters -->
                        <div id="supertrendParams" class="strategy-params" style="display: none;">
                            <h6 class="mt-4 mb-3">Supertrend Parameters</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="atrPeriodInput" class="form-label">ATR Period</label>
                                    <input type="number" class="form-control" id="atrPeriodInput" min="1" max="50" value="10">
                                </div>
                                <div class="col-md-4">
                                    <label for="multiplierInput" class="form-label">Multiplier</label>
                                    <input type="number" class="form-control" id="multiplierInput" min="1" max="10" step="0.1" value="3">
                                </div>
                                <div class="col-md-4">
                                    <label for="timeframeSelect" class="form-label">Timeframe</label>
                                    <select class="form-select" id="timeframeSelect">
                                        <option value="5Min">5 Minutes</option>
                                        <option value="15Min">15 Minutes</option>
                                        <option value="30Min">30 Minutes</option>
                                        <option value="1H" selected>1 Hour</option>
                                        <option value="1D">1 Day</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MACD Parameters -->
                        <div id="macdParams" class="strategy-params" style="display: none;">
                            <h6 class="mt-4 mb-3">MACD Parameters</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="emaPeriodInput" class="form-label">EMA Period</label>
                                    <input type="number" class="form-control" id="emaPeriodInput" min="1" max="50" value="9">
                                </div>
                                <div class="col-md-4">
                                    <label for="macdFastInput" class="form-label">MACD Fast</label>
                                    <input type="number" class="form-control" id="macdFastInput" min="1" max="50" value="12">
                                </div>
                                <div class="col-md-4">
                                    <label for="macdSlowInput" class="form-label">MACD Slow</label>
                                    <input type="number" class="form-control" id="macdSlowInput" min="1" max="100" value="26">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="macdSignalInput" class="form-label">MACD Signal</label>
                                    <input type="number" class="form-control" id="macdSignalInput" min="1" max="50" value="9">
                                </div>
                                <div class="col-md-4">
                                    <label for="rsiPeriodInput" class="form-label">RSI Period</label>
                                    <input type="number" class="form-control" id="rsiPeriodInput" min="1" max="50" value="14">
                                </div>
                                <div class="col-md-4">
                                    <label for="macdTimeframeSelect" class="form-label">Timeframe</label>
                                    <select class="form-select" id="macdTimeframeSelect">
                                        <option value="5Min">5 Minutes</option>
                                        <option value="15Min">15 Minutes</option>
                                        <option value="30Min">30 Minutes</option>
                                        <option value="1H" selected>1 Hour</option>
                                        <option value="1D">1 Day</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Parameters -->
                        <div id="customParams" class="strategy-params" style="display: none;">
                            <h6 class="mt-4 mb-3">Custom Parameters</h6>
                            <div class="mb-3">
                                <label for="customParameters" class="form-label">Parameters (JSON)</label>
                                <textarea class="form-control" id="customParameters" rows="5" placeholder='{"param1": 10, "param2": "value"}'></textarea>
                                <small class="text-muted">Enter parameters as JSON object</small>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3 mt-4">
                            <input class="form-check-input" type="checkbox" id="backtest" checked>
                            <label class="form-check-label" for="backtest">
                                Run backtest before adding
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addStrategyBtn">Add Strategy</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Strategy Details Modal -->
    <div class="modal fade" id="strategyDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyTitle">Strategy Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Strategy Information</h6>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <th>Symbol</th>
                                        <td id="detailSymbol">-</td>
                                    </tr>
                                    <tr>
                                        <th>Type</th>
                                        <td id="detailType">-</td>
                                    </tr>
                                    <tr>
                                        <th>Created</th>
                                        <td id="detailCreated">-</td>
                                    </tr>
                                    <tr>
                                        <th>Current Signal</th>
                                        <td id="detailSignal">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Performance Metrics</h6>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <th>Win Rate</th>
                                        <td id="detailWinRate">-</td>
                                    </tr>
                                    <tr>
                                        <th>Total P&L</th>
                                        <td id="detailPnL">-</td>
                                    </tr>
                                    <tr>
                                        <th>Total Trades</th>
                                        <td id="detailTrades">-</td>
                                    </tr>
                                    <tr>
                                        <th>Avg. Hold Time</th>
                                        <td id="detailHoldTime">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <h6>Parameters</h6>
                    <div id="detailParameters" class="border rounded p-3 mb-4 bg-light">
                        <pre><code>{ }</code></pre>
                    </div>
                    
                    <h6>Recent Activity</h6>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Action</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody id="detailActivity">
                            <tr>
                                <td colspan="5" class="text-center">No recent activity</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" id="deleteStrategyBtn">
                        <i class="bi bi-trash me-2"></i>Delete Strategy
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle me-2"></i>
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <small id="toastTime">Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Strategy added successfully.
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="/static/js/dashboard.js"></script>
    <script>
        $(document).ready(function() {
            // Load symbols and strategies
            loadSymbols();
            loadStrategies();
            
            // Set up event handlers
            setupEventHandlers();
            
            // Check trading status
            checkTradingStatus();
        });
        
        // Set up event handlers
        function setupEventHandlers() {
            // Strategy type selection
            $('#strategySelect').change(function() {
                const strategy = $(this).val();
                $('.strategy-params').hide();
                if (strategy) {
                    $(`#${strategy}Params`).show();
                }
            });
            
            // Add strategy button
            $('#addStrategyBtn').click(function() {
                addStrategy();
            });
            
            // View strategy details
            $(document).on('click', '.view-strategy-btn', function() {
                const strategyId = $(this).data('id');
                showStrategyDetails(strategyId);
            });
            
            // Delete strategy
            $('#deleteStrategyBtn').click(function() {
                const strategyId = $(this).data('id');
                deleteStrategy(strategyId);
            });
        }
        
        // Load strategies
        function loadStrategies() {
            $.get('/api/strategies', function(data) {
                updateStrategiesUI(data);
            }).fail(handleApiError);
        }
        
        // Update strategies UI
        function updateStrategiesUI(strategies) {
            const container = $('#strategiesContainer');
            container.empty();
            
            if (!strategies || strategies.length === 0) {
                container.html(`
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-info-circle text-muted mb-3" style="font-size: 3rem;"></i>
                        <h5 class="text-muted">No Active Strategies</h5>
                        <p class="text-muted mb-4">Click "Add Strategy" to create your first trading strategy.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStrategyModal">
                            <i class="bi bi-plus-circle me-2"></i>Add Strategy
                        </button>
                    </div>
                `);
                return;
            }
            
            strategies.forEach(strategy => {
                const signalClass = 
                    strategy.current_signal === 'BUY' ? 'buy' : 
                    strategy.current_signal === 'SELL' ? 'sell' : 'neutral';
                
                const strategyIcon = strategy.type === 'supertrend' 
                    ? '<i class="bi bi-graph-up"></i>' 
                    : '<i class="bi bi-bar-chart"></i>';
                
                const card = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="strategy-icon">${strategyIcon}</div>
                                    ${strategy.symbol}
                                </div>
                                <span class="badge ${strategy.current_signal === 'BUY' ? 'bg-success' : strategy.current_signal === 'SELL' ? 'bg-danger' : 'bg-secondary'}">
                                    ${strategy.current_signal}
                                </span>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title">${strategy.type.charAt(0).toUpperCase() + strategy.type.slice(1)} Strategy</h6>
                                
                                <div class="strategy-metrics">
                                    <div class="metric">
                                        <span class="metric-label">Position</span>
                                        <span class="metric-value">${strategy.position_size || 'None'}</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">P&L</span>
                                        <span class="metric-value ${strategy.pnl >= 0 ? 'positive' : 'negative'}">
                                            ${strategy.pnl ? (strategy.pnl >= 0 ? '+' : '') + strategy.pnl.toFixed(2) + '%' : '0.00%'}
                                        </span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Created</span>
                                        <span class="metric-value">${formatTimestamp(strategy.created_at)}</span>
                                    </div>
                                </div>
                                
                                <div class="parameter-preview mt-3">
                                    ${renderParameters(strategy.parameters)}
                                </div>
                            </div>
                            <div class="card-footer text-center">
                                <button class="btn btn-sm btn-primary view-strategy-btn" data-id="${strategy.id}">
                                    <i class="bi bi-eye me-1"></i> View Details
                                </button>
                                <button class="btn btn-sm btn-outline-danger remove-strategy-btn" data-id="${strategy.id}">
                                    <i class="bi bi-trash me-1"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.append(card);
            });
            
            // Setup remove strategy buttons
            $('.remove-strategy-btn').click(function() {
                const strategyId = $(this).data('id');
                deleteStrategy(strategyId);
            });
        }
        
        // Render parameters preview
        function renderParameters(parameters) {
            if (!parameters) return '';
            
            let result = '<div class="parameters-table">';
            
            // Show only the first 3 parameters
            const keys = Object.keys(parameters).slice(0, 3);
            
            keys.forEach(key => {
                result += `
                    <div class="parameter-row">
                        <span class="parameter-name">${key}:</span>
                        <span class="parameter-value">${parameters[key]}</span>
                    </div>
                `;
            });
            
            if (Object.keys(parameters).length > 3) {
                result += '<div class="parameter-row text-muted">and more...</div>';
            }
            
            result += '</div>';
            return result;
        }
        
        // Show strategy details
        function showStrategyDetails(strategyId) {
            $.get(`/api/strategies/${strategyId}`, function(data) {
                // Update strategy details in modal
                $('#strategyTitle').text(`${data.symbol} - ${data.type.charAt(0).toUpperCase() + data.type.slice(1)} Strategy`);
                $('#detailSymbol').text(data.symbol);
                $('#detailType').text(data.type.charAt(0).toUpperCase() + data.type.slice(1));
                $('#detailCreated').text(formatTimestamp(data.created_at));
                
                // Update signal with appropriate class
                const signalElement = $('#detailSignal');
                signalElement.text(data.current_signal);
                signalElement.removeClass('text-success text-danger text-secondary');
                if (data.current_signal === 'BUY') {
                    signalElement.addClass('text-success');
                } else if (data.current_signal === 'SELL') {
                    signalElement.addClass('text-danger');
                } else {
                    signalElement.addClass('text-secondary');
                }
                
                // Update performance metrics
                $('#detailWinRate').text(data.performance ? `${data.performance.win_rate.toFixed(1)}%` : 'N/A');
                $('#detailPnL').text(data.performance ? `${data.performance.pnl >= 0 ? '+' : ''}${data.performance.pnl.toFixed(2)}%` : 'N/A');
                $('#detailTrades').text(data.performance ? data.performance.total_trades : 'N/A');
                $('#detailHoldTime').text(data.performance ? data.performance.avg_hold_time : 'N/A');
                
                // Update parameters
                $('#detailParameters pre code').text(JSON.stringify(data.parameters, null, 4));
                
                // Update activity table
                updateActivityTable(data.activity);
                
                // Set strategy ID for delete button
                $('#deleteStrategyBtn').data('id', strategyId);
                
                // Show modal
                $('#strategyDetailsModal').modal('show');
            }).fail(handleApiError);
        }
        
        // Update activity table
        function updateActivityTable(activity) {
            const table = $('#detailActivity');
            table.empty();
            
            if (!activity || activity.length === 0) {
                table.html(`
                    <tr>
                        <td colspan="5" class="text-center">No recent activity</td>
                    </tr>
                `);
                return;
            }
            
            activity.forEach(item => {
                const pnlClass = item.pnl >= 0 ? 'text-success' : 'text-danger';
                const row = `
                    <tr>
                        <td>${formatTimestamp(item.date)}</td>
                        <td>${item.action}</td>
                        <td>${parseFloat(item.quantity).toFixed(6)}</td>
                        <td>$${parseFloat(item.price).toFixed(2)}</td>
                        <td class="${pnlClass}">${item.pnl ? (item.pnl >= 0 ? '+' : '') + item.pnl.toFixed(2) + '%' : '-'}</td>
                    </tr>
                `;
                table.append(row);
            });
        }
        
        // Delete strategy
        function deleteStrategy(strategyId) {
            if (confirm('Are you sure you want to delete this strategy?')) {
                $.ajax({
                    url: `/api/strategies/${strategyId}`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showNotification('Success', 'Strategy deleted successfully', 'success');
                            $('#strategyDetailsModal').modal('hide');
                            loadStrategies();
                        } else {
                            showNotification('Error', response.message || 'Failed to delete strategy', 'danger');
                        }
                    },
                    error: handleApiError
                });
            }
        }
    </script>
</body>
</html> 